<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movie Picker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        
        /* Динамический фон с затемнением */
        #bg-image {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center top;
            transition: opacity 0.5s ease-in-out;
            opacity: 0; /* Скрыт по умолчанию */
        }
        .bg-overlay {
             position: fixed;
             top: 0; left: 0; width: 100%; height: 100%;
             background: linear-gradient(to top, #111111 20%, rgba(17,17,17,0.6) 100%);
             z-index: -1;
        }

        /* Кастомные стили для элементов */
        .panel-dark { background-color: rgba(24, 24, 27, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-dark { @apply bg-zinc-800 border-zinc-700 text-white focus:border-red-500 transition; }
        .btn-primary { @apply bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-900/30 transform active:scale-[0.98] transition-all; }

        /* Анимация загрузки */
        .loader { border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#111111] text-gray-100 min-h-screen flex flex-col">

    <div id="bg-image"></div>
    <div class="bg-overlay"></div>

    <div id="apiKeyModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50 hidden p-4">
        <div class="panel-dark p-8 rounded-2xl max-w-md w-full text-center border-red-900/50">
            <h2 class="text-2xl font-extrabold mb-2 text-red-500">Требуется доступ</h2>
            <p class="text-gray-400 mb-6 text-sm leading-relaxed">Для работы сайта необходим бесплатный API Key от TMDB. Он будет сохранен только в вашем браузере.</p>
            <input type="text" id="apiKeyInput" placeholder="Вставьте ваш TMDB API Key v3 (auth)" class="w-full p-4 rounded-lg input-dark outline-none mb-4 font-mono text-sm border">
            <button onclick="saveApiKey()" class="btn-primary w-full py-3">Сохранить и продолжить</button>
            <p class="mt-6 text-xs text-gray-500">Нет ключа? <a href="https://www.themoviedb.org/settings/api" target="_blank" class="text-red-400 hover:underline">Получить на TMDB</a></p>
        </div>
    </div>

    <main class="flex-grow container mx-auto px-4 py-8 md:py-12 flex flex-col items-center max-w-5xl">
        
        <header class="text-center mb-10 md:mb-14">
            <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight text-white mb-4">
                Кино<span class="text-red-600">Рандом</span>
            </h1>
            <p class="text-lg text-gray-400 max-w-xl mx-auto">Только качественные фильмы. Никакого ноунейм трэша.</p>
        </header>

        <div class="w-full flex flex-col lg:flex-row gap-8 items-start relative z-10">
            
            <section class="panel-dark w-full lg:w-1/3 p-6 md:p-8 rounded-2xl shadow-xl backdrop-blur-sm relative">
                 <div class="absolute -top-10 -left-10 w-40 h-40 bg-red-600/20 rounded-full blur-[100px] pointer-events-none"></div>

                <h3 class="text-xl font-bold mb-6 flex items-center gap-2"><span class="text-red-500">#</span> Параметры поиска</h3>
                
                <div class="space-y-5">
                    <div class="flex flex-col">
                        <label class="text-sm font-semibold text-gray-400 mb-2 pl-1">Жанр</label>
                        <select id="genreSelect" class="p-3 rounded-lg input-dark outline-none border appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2013%205.4s9.2-1.8%2013-5.4L287%2095.2a17.6%2017.6%200%200%200%205.4-13%2017.6%2017.6%200%200%200-5.4-12.6z%22%2F%3E%3C%2Fsvg%3E')] bg-no-repeat bg-[length:12px] bg-[right:1rem_center]">
                            <option value="">Все жанры</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col">
                         <div class="flex justify-between mb-2 pl-1">
                            <label class="text-sm font-semibold text-gray-400">Мин. рейтинг TMDB</label>
                            <span id="ratingValue" class="text-red-500 font-bold">6.5</span>
                        </div>
                        <input type="range" id="ratingRange" min="5" max="9" step="0.5" value="6.5" class="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-red-600">
                    </div>

                    <div class="flex flex-col">
                        <label class="text-sm font-semibold text-gray-400 mb-2 pl-1">Год выхода (от)</label>
                        <input type="number" id="yearInput" value="2005" min="1970" max="2024" class="p-3 rounded-lg input-dark outline-none border">
                    </div>
                </div>

                <button id="generateBtn" onclick="findQualityMovie()" class="btn-primary w-full mt-8 flex justify-center items-center gap-3 text-lg">
                    <span id="btnText">Найти отличный фильм</span>
                    <div id="btnLoader" class="loader hidden"></div>
                </button>
            </section>

            <section id="movieCard" class="w-full lg:w-2/3 hidden animate-fade-in relative z-20">
                <div class="panel-dark rounded-2xl overflow-hidden shadow-2xl border-red-900/30 flex flex-col md:flex-row">
                    
                    <div class="w-full md:w-2/5 relative shrink-0">
                        <img id="moviePoster" src="" alt="Poster" class="w-full h-[400px] md:h-full object-cover shadow-[inset_0_-50px_60px_-20px_rgba(0,0,0,0.8)]">
                        <div class="absolute top-4 left-4 bg-black/80 backdrop-blur-md px-3 py-1.5 rounded-lg font-bold text-white flex items-center gap-1 border border-yellow-500/30 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-yellow-500"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" /></svg>
                            <span id="movieRating" class="text-lg"></span>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-8 flex flex-col justify-center">
                         <div class="mb-4 flex flex-wrap gap-2 text-xs font-bold text-red-400 uppercase tracking-wider">
                            <span id="movieYear" class="bg-red-900/20 px-2 py-1 rounded"></span>
                            <span id="movieLang" class="bg-red-900/20 px-2 py-1 rounded"></span>
                        </div>
                        <h2 id="movieTitle" class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight"></h2>
                        
                        <p id="movieOverview" class="text-gray-300 leading-relaxed mb-8 text-base md:text-lg line-clamp-6 md:line-clamp-none overflow-y-auto max-h-[300px] pr-2 "></p>
                        
                        <div class="flex flex-col sm:flex-row gap-4 mt-auto">
                            <a id="tmdbLink" href="#" target="_blank" class="bg-white text-black hover:bg-gray-200 font-bold px-6 py-3 rounded-xl transition text-center flex items-center justify-center gap-2">
                                Подробнее
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                            </a>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="p-6 text-center text-zinc-600 text-sm">
        <p>Данные предоставлены TMDB API. Некоммерческое использование.</p>
    </footer>

    <script>
        // === НАСТРОЙКИ ===
        const API_BASE_URL = 'https://api.themoviedb.org/3';
        // Минимальное количество голосов, чтобы считать фильм "известным"
        const MIN_VOTE_COUNT = 300; 
        // Сколько первых страниц популярных фильмов рассматривать для рандома (20 стр * 20 фильмов = топ 400)
        const MAX_PAGE_DEPTH = 20; 

        let API_KEY = localStorage.getItem('tmdb_api_key_v2'); // Используем новый ключ в хранилище

        // Инициализация
        window.onload = () => {
            if (!API_KEY) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            } else {
                loadGenres();
            }
        };

        // Сохранение ключа
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input.length > 20) {
                localStorage.setItem('tmdb_api_key_v2', input);
                API_KEY = input;
                document.getElementById('apiKeyModal').classList.add('hidden');
                loadGenres();
            } else {
                alert('Ключ выглядит слишком коротким. Проверьте правильность.');
            }
        }

        // Ползунок рейтинга
        document.getElementById('ratingRange').addEventListener('input', (e) => {
            document.getElementById('ratingValue').innerText = Number(e.target.value).toFixed(1);
        });

        // Загрузка жанров
        async function loadGenres() {
            try {
                const res = await fetch(`${API_BASE_URL}/genre/movie/list?api_key=${API_KEY}&language=ru-RU`);
                if (!res.ok) throw new Error('Auth failed');
                const data = await res.json();
                const select = document.getElementById('genreSelect');
                data.genres.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.innerText = g.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error(e);
                localStorage.removeItem('tmdb_api_key_v2');
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
        }

        // === ГЛАВНАЯ ФУНКЦИЯ ПОИСКА ===
        async function findQualityMovie() {
            setLoading(true);
            
            const genre = document.getElementById('genreSelect').value;
            const rating = document.getElementById('ratingRange').value;
            const year = document.getElementById('yearInput').value;

            // Базовый URL с фильтрами качества
            let discoverUrl = `${API_BASE_URL}/discover/movie?api_key=${API_KEY}&language=ru-RU&include_adult=false`;
            // ВАЖНО: Сортируем по популярности и отсекаем фильмы с малым кол-вом голосов
            discoverUrl += `&sort_by=popularity.desc&vote_count.gte=${MIN_VOTE_COUNT}`;

            if (genre) discoverUrl += `&with_genres=${genre}`;
            if (rating) discoverUrl += `&vote_average.gte=${rating}`;
            if (year) discoverUrl += `&primary_release_date.gte=${year}-01-01`;

            try {
                // 1. Делаем "разведывательный" запрос на 1 страницу
                const initialRes = await fetch(discoverUrl + '&page=1');
                const initialData = await initialRes.json();
                
                if (initialData.total_results === 0) {
                    alert('По этим критериям известных фильмов не найдено. Попробуйте смягчить фильтры.');
                    setLoading(false);
                    return;
                }

                // 2. Определяем, из скольких страниц будем выбирать (не больше MAX_PAGE_DEPTH)
                const availablePages = Math.min(initialData.total_pages, MAX_PAGE_DEPTH);
                
                // 3. Выбираем случайную страницу из этого "топа"
                const randomPage = Math.floor(Math.random() * availablePages) + 1;

                let results;
                // Если выпала первая страница, используем уже полученные данные
                if (randomPage === 1) {
                    results = initialData.results;
                } else {
                    const finalRes = await fetch(`${discoverUrl}&page=${randomPage}`);
                    const finalData = await finalRes.json();
                    results = finalData.results;
                }

                // 4. Выбираем случайный фильм с страницы
                const randomMovieIndex = Math.floor(Math.random() * results.length);
                const movie = results[randomMovieIndex];

                if (movie) {
                    displayMovie(movie);
                } else {
                    throw new Error('Ошибка выборки фильма');
                }

            } catch (error) {
                console.error(error);
                alert('Ошибка запроса к TMDB. Возможно, проблемы с API ключом или сетью.');
            } finally {
                setLoading(false);
            }
        }

        // Отображение фильма
        function displayMovie(movie) {
            const card = document.getElementById('movieCard');
            const bgImage = document.getElementById('bg-image');

            // Текстовые данные
            document.getElementById('movieTitle').innerText = movie.title;
            document.getElementById('movieOverview').innerText = movie.overview || "Описание на русском языке отсутствует.";
            document.getElementById('movieRating').innerText = movie.vote_average.toFixed(1);
            document.getElementById('movieYear').innerText = movie.release_date ? movie.release_date.split('-')[0] : 'N/A';
            document.getElementById('movieLang').innerText = movie.original_language.toUpperCase();
            document.getElementById('tmdbLink').href = `https://www.themoviedb.org/movie/${movie.id}`;
            
            // Постер
            const posterPath = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` 
                : 'https://via.placeholder.com/500x750?text=No+Poster';
            document.getElementById('moviePoster').src = posterPath;

            // ДИНАМИЧЕСКИЙ ФОН (Backdrop)
            if (movie.backdrop_path) {
                // Загружаем картинку в фоне перед показом
                const img = new Image();
                img.src = `https://image.tmdb.org/t/p/original${movie.backdrop_path}`;
                img.onload = () => {
                    bgImage.style.backgroundImage = `url('${img.src}')`;
                    bgImage.style.opacity = '1'; // Плавно показываем
                };
            } else {
                 bgImage.style.opacity = '0'; // Скрываем, если фона нет
            }

            // Показываем карточку и скроллим
            card.classList.remove('hidden');
            
            // На мобилках скроллим к результату
            if(window.innerWidth < 1024) {
                 setTimeout(() => {
                     card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 }, 100);
            }
        }

        // Управление состоянием кнопки
        function setLoading(isLoading) {
            const btn = document.getElementById('generateBtn');
            const loader = document.getElementById('btnLoader');
            const btnText = document.getElementById('btnText');
            
            if (isLoading) {
                btn.disabled = true;
                btnText.innerText = 'Ищем...';
                loader.classList.remove('hidden');
                document.getElementById('movieCard').classList.add('hidden'); // Скрываем старый результат
                 document.getElementById('bg-image').style.opacity = '0'; // Скрываем старый фон
            } else {
                btn.disabled = false;
                btnText.innerText = 'Найти отличный фильм';
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
