<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Что посмотреть вместе</title>
    <style>
        /* Здесь можно вставить CSS из вашего существующего проекта */
    </style>
</head>
<body>
    <div class="container">
        <h1>Что посмотреть вместе</h1>
        
        <div class="film-selector">
            <h2>Выберите фильмы</h2>
            
            <div class="user-inputs">
                <div class="user-section">
                    <h3>Ваш выбор</h3>
                    <div class="search-container">
                        <input type="text" id="yourMovieSearch" placeholder="Начните вводить название фильма...">
                        <button id="yourMovieSearchBtn">Искать</button>
                    </div>
                    <div id="yourMovieResults" class="movie-results"></div>
                    <div id="yourSelectedMovie" class="selected-movie"></div>
                </div>
                
                <div class="user-section">
                    <h3>Выбор вашей девушки</h3>
                    <div class="search-container">
                        <input type="text" id="partnerMovieSearch" placeholder="Начните вводить название фильма...">
                        <button id="partnerMovieSearchBtn">Искать</button>
                    </div>
                    <div id="partnerMovieResults" class="movie-results"></div>
                    <div id="partnerSelectedMovie" class="selected-movie"></div>
                </div>
            </div>
            
            <button id="findMatchBtn" disabled>Найти подходящий фильм для совместного просмотра</button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">Подбираем идеальный фильм для вас обоих</div>
        
        <div id="matchedMovie" class="movie-card" style="display: none;">
            <!-- Здесь будет отображаться рекомендованный фильм -->
        </div>
        
        <div id="recommendation-explanation" class="recommendation-explanation" style="display: none;">
            <!-- Здесь будет отображаться объяснение рекомендации -->
        </div>
    </div>

    <script>
        const apiKey = 'a459e5722a451a02c4fbee9d3c1f4e45';
        let yourSelectedMovie = null;
        let partnerSelectedMovie = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Настраиваем обработчики поиска фильмов
            document.getElementById('yourMovieSearchBtn').addEventListener('click', function() {
                searchMovies(document.getElementById('yourMovieSearch').value, 'yours');
            });
            
            document.getElementById('partnerMovieSearchBtn').addEventListener('click', function() {
                searchMovies(document.getElementById('partnerMovieSearch').value, 'partner');
            });
            
            // Обработчик для поиска по нажатию Enter
            document.getElementById('yourMovieSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMovies(this.value, 'yours');
                }
            });
            
            document.getElementById('partnerMovieSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMovies(this.value, 'partner');
                }
            });
            
            // Обработчик для кнопки нахождения общего фильма
            document.getElementById('findMatchBtn').addEventListener('click', findMatchingMovie);
        });
        
        // Функция для поиска фильмов по названию
        function searchMovies(query, userType) {
            if (!query.trim()) return;
            
            const resultsContainer = userType === 'yours' ? 
                document.getElementById('yourMovieResults') : 
                document.getElementById('partnerMovieResults');
            
            resultsContainer.innerHTML = '<div class="loading-results">Ищем фильмы...</div>';
            
            fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&language=ru&query=${encodeURIComponent(query)}&page=1`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    
                    if (data.results && data.results.length > 0) {
                        // Отображаем первые 5 результатов
                        const results = data.results.slice(0, 5);
                        
                        results.forEach(movie => {
                            const movieElement = document.createElement('div');
                            movieElement.className = 'movie-result-item';
                            
                            const releaseYear = movie.release_date ? `(${movie.release_date.substring(0, 4)})` : '';
                            
                            movieElement.innerHTML = `
                                <div class="movie-result-title">${movie.title} ${releaseYear}</div>
                                <button class="select-movie-btn" data-id="${movie.id}" data-user="${userType}">Выбрать</button>
                            `;
                            
                            resultsContainer.appendChild(movieElement);
                        });
                        
                        // Добавляем обработчики для кнопок выбора
                        document.querySelectorAll('.select-movie-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const movieId = this.dataset.id;
                                const userType = this.dataset.user;
                                selectMovie(movieId, userType);
                            });
                        });
                    } else {
                        resultsContainer.innerHTML = '<div class="no-results">Фильмы не найдены</div>';
                    }
                })
                .catch(error => {
                    console.error('Ошибка при поиске фильмов:', error);
                    resultsContainer.innerHTML = '<div class="error">Произошла ошибка при поиске</div>';
                });
        }
        
        // Функция для выбора фильма
        function selectMovie(movieId, userType) {
            fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${apiKey}&language=ru&append_to_response=credits,keywords`)
                .then(response => response.json())
                .then(movie => {
                    const selectedMovieContainer = userType === 'yours' ? 
                        document.getElementById('yourSelectedMovie') : 
                        document.getElementById('partnerSelectedMovie');
                    
                    const resultsContainer = userType === 'yours' ? 
                        document.getElementById('yourMovieResults') : 
                        document.getElementById('partnerMovieResults');
                    
                    // Очищаем результаты поиска
                    resultsContainer.innerHTML = '';
                    
                    // Сохраняем выбранный фильм в глобальную переменную
                    if (userType === 'yours') {
                        yourSelectedMovie = movie;
                    } else {
                        partnerSelectedMovie = movie;
                    }
                    
                    // Отображаем выбранный фильм
                    let genresText = movie.genres ? movie.genres.map(genre => genre.name).join(', ') : '';
                    let posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : '/api/placeholder/200/300';
                    
                    selectedMovieContainer.innerHTML = `
                        <div class="selected-movie-card">
                            <img src="${posterUrl}" alt="${movie.title}" class="selected-movie-poster">
                            <div class="selected-movie-info">
                                <h4>${movie.title} (${movie.release_date ? movie.release_date.substring(0, 4) : 'Н/Д'})</h4>
                                <div class="selected-movie-meta">
                                    <span>${genresText}</span>
                                    <span class="rating">${movie.vote_average}</span>
                                </div>
                                <button class="change-movie-btn" data-user="${userType}">Изменить выбор</button>
                            </div>
                        </div>
                    `;
                    
                    // Добавляем обработчик для кнопки "Изменить выбор"
                    document.querySelector(`.change-movie-btn[data-user="${userType}"]`).addEventListener('click', function() {
                        if (userType === 'yours') {
                            yourSelectedMovie = null;
                        } else {
                            partnerSelectedMovie = null;
                        }
                        
                        selectedMovieContainer.innerHTML = '';
                        updateFindButtonState();
                    });
                    
                    // Обновляем состояние кнопки поиска совместного фильма
                    updateFindButtonState();
                })
                .catch(error => {
                    console.error('Ошибка при получении информации о фильме:', error);
                });
        }
        
        // Обновление состояния кнопки поиска совместного фильма
        function updateFindButtonState() {
            const findButton = document.getElementById('findMatchBtn');
            findButton.disabled = !(yourSelectedMovie && partnerSelectedMovie);
        }
        
        // Функция для нахождения подходящего фильма на основе двух выбранных
        function findMatchingMovie() {
            if (!yourSelectedMovie || !partnerSelectedMovie) return;
            
            // Показываем индикатор загрузки
            document.getElementById('loading').style.display = 'block';
            document.getElementById('matchedMovie').style.display = 'none';
            document.getElementById('recommendation-explanation').style.display = 'none';
            
            // Получаем общие жанры
            const yourGenreIds = yourSelectedMovie.genres.map(genre => genre.id);
            const partnerGenreIds = partnerSelectedMovie.genres.map(genre => genre.id);
            const commonGenreIds = yourGenreIds.filter(id => partnerGenreIds.includes(id));
            
            // Если есть общие жанры, ищем фильмы с этими жанрами
            // Иначе объединяем жанры для более широкого поиска
            const genreIds = commonGenreIds.length > 0 ? commonGenreIds : [...new Set([...yourGenreIds, ...partnerGenreIds])];
            
            // Получаем ключевые слова из обоих фильмов
            let keywordIds = [];
            if (yourSelectedMovie.keywords && yourSelectedMovie.keywords.keywords) {
                keywordIds = [...keywordIds, ...yourSelectedMovie.keywords.keywords.map(kw => kw.id)];
            }
            if (partnerSelectedMovie.keywords && partnerSelectedMovie.keywords.keywords) {
                keywordIds = [...keywordIds, ...partnerSelectedMovie.keywords.keywords.map(kw => kw.id)];
            }
            // Выбираем до 5 ключевых слов
            keywordIds = [...new Set(keywordIds)].slice(0, 5);
            
            // Получаем средний рейтинг для фильтрации
            const averageRating = (yourSelectedMovie.vote_average + partnerSelectedMovie.vote_average) / 2;
            const minRating = Math.max(averageRating - 1, 6); // Не ниже 6 или на 1 балл ниже среднего
            
            // Формируем URL для поиска фильмов
            let url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&language=ru&sort_by=popularity.desc`;
            
            // Добавляем жанры
            if (genreIds.length > 0) {
                url += `&with_genres=${genreIds.join(',')}`;
            }
            
            // Добавляем ключевые слова (если есть)
            if (keywordIds.length > 0) {
                url += `&with_keywords=${keywordIds.join('|')}`;
            }
            
            // Добавляем фильтр по рейтингу
            url += `&vote_average.gte=${minRating}`;
            
            // Исключаем уже выбранные фильмы
            url += `&without_movies=${yourSelectedMovie.id},${partnerSelectedMovie.id}`;
            
            // Добавляем случайную страницу (до 5-й страницы)
            const randomPage = Math.floor(Math.random() * 5) + 1;
            url += `&page=${randomPage}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        // Исключаем уже просмотренные фильмы (если есть)
                        let filteredResults = data.results.filter(movie => 
                            movie.id !== yourSelectedMovie.id && movie.id !== partnerSelectedMovie.id
                        );
                        
                        // Если результатов нет, берем оригинальные результаты
                        if (filteredResults.length === 0) {
                            filteredResults = data.results;
                        }
                        
                        // Выбираем случайный фильм из первых 10 результатов (или меньше, если результатов меньше)
                        const randomIndex = Math.floor(Math.random() * Math.min(filteredResults.length, 10));
                        const matchedMovie = filteredResults[randomIndex];
                        
                        // Получаем дополнительную информацию о фильме
                        fetch(`https://api.themoviedb.org/3/movie/${matchedMovie.id}?api_key=${apiKey}&language=ru&append_to_response=videos,credits`)
                            .then(response => response.json())
                            .then(movieDetails => {
                                // Отображаем найденный фильм
                                displayMatchedMovie(movieDetails);
                                
                                // Генерируем и отображаем объяснение рекомендации
                                displayRecommendationExplanation(movieDetails, commonGenreIds);
                            })
                            .catch(error => {
                                console.error('Ошибка при получении деталей фильма:', error);
                                showErrorNotification('Произошла ошибка при получении информации о фильме');
                            });
                    } else {
                        // Пробуем более широкий поиск, если ничего не нашли
                        fallbackMovieSearch();
                    }
                })
                .catch(error => {
                    console.error('Ошибка при поиске фильмов:', error);
                    showErrorNotification('Произошла ошибка при поиске фильмов');
                    document.getElementById('loading').style.display = 'none';
                });
        }
        
        // Резервный поиск фильмов с более широкими параметрами
        function fallbackMovieSearch() {
            // Берем только один случайный жанр из каждого фильма
            const yourRandomGenre = yourSelectedMovie.genres.length > 0 ? 
                yourSelectedMovie.genres[Math.floor(Math.random() * yourSelectedMovie.genres.length)].id : null;
                
            const partnerRandomGenre = partnerSelectedMovie.genres.length > 0 ? 
                partnerSelectedMovie.genres[Math.floor(Math.random() * partnerSelectedMovie.genres.length)].id : null;
            
            // Формируем URL для поиска с более общими параметрами
            let url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&language=ru&sort_by=popularity.desc&vote_average.gte=7`;
            
            // Добавляем жанры, если они есть
            if (yourRandomGenre && partnerRandomGenre) {
                url += `&with_genres=${yourRandomGenre}|${partnerRandomGenre}`;
            } else if (yourRandomGenre) {
                url += `&with_genres=${yourRandomGenre}`;
            } else if (partnerRandomGenre) {
                url += `&with_genres=${partnerRandomGenre}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        // Выбираем случайный фильм из первых 10 результатов
                        const randomIndex = Math.floor(Math.random() * Math.min(data.results.length, 10));
                        const matchedMovie = data.results[randomIndex];
                        
                        // Получаем дополнительную информацию о фильме
                        fetch(`https://api.themoviedb.org/3/movie/${matchedMovie.id}?api_key=${apiKey}&language=ru&append_to_response=videos,credits`)
                            .then(response => response.json())
                            .then(movieDetails => {
                                // Отображаем найденный фильм
                                displayMatchedMovie(movieDetails);
                                
                                // Отображаем объяснение рекомендации
                                displayRecommendationExplanation(movieDetails, []);
                            })
                            .catch(error => {
                                console.error('Ошибка при получении деталей фильма:', error);
                                showErrorNotification('Произошла ошибка при получении информации о фильме');
                            });
                    } else {
                        document.getElementById('loading').style.display = 'none';
                        showErrorNotification('К сожалению, не удалось найти подходящий фильм. Попробуйте выбрать другие фильмы');
                    }
                })
                .catch(error => {
                    console.error('Ошибка при резервном поиске фильмов:', error);
                    document.getElementById('loading').style.display = 'none';
                    showErrorNotification('Произошла ошибка при поиске фильмов');
                });
        }
        
        // Функция отображения найденного фильма
        function displayMatchedMovie(movie) {
            document.getElementById('loading').style.display = 'none';
            
            const matchedMovieContainer = document.getElementById('matchedMovie');
            
            let genresText = movie.genres ? movie.genres.map(genre => genre.name).join(', ') : '';
            let posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : '/api/placeholder/500/750';
            
            // Формируем список актеров
            let castList = '';
            if (movie.credits && movie.credits.cast && movie.credits.cast.length > 0) {
                const topCast = movie.credits.cast.slice(0, 5);
                castList = `<div class="movie-cast">В ролях: ${topCast.map(actor => actor.name).join(', ')}</div>`;
            }
            
            // Формируем информацию о трейлере
            let trailerButton = '';
            if (movie.videos && movie.videos.results && movie.videos.results.length > 0) {
                const trailer = movie.videos.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                if (trailer) {
                    trailerButton = `
                        <a href="https://www.youtube.com/watch?v=${trailer.key}" target="_blank" class="trailer-btn">
                            Смотреть трейлер
                        </a>
                    `;
                }
            }
            
            matchedMovieContainer.innerHTML = `
                <div class="movie-poster">
                    <img src="${posterUrl}" alt="${movie.title}">
                </div>
                <div class="movie-info">
                    <h2 class="movie-title">${movie.title}</h2>
                    <div class="movie-meta">
                        <span>${movie.release_date ? movie.release_date.substring(0, 4) : 'Н/Д'}</span>
                        <span>${genresText}</span>
                        <span class="rating">${movie.vote_average}</span>
                    </div>
                    <p class="movie-description">${movie.overview || 'Описание отсутствует'}</p>
                    ${castList}
                    <div class="movie-actions">
                        ${trailerButton}
                        <button id="findAnotherBtn" class="find-another-btn">Подобрать другой фильм</button>
                    </div>
                </div>
            `;
            
            matchedMovieContainer.style.display = 'flex';
            
            // Добавляем обработчик для кнопки "Подобрать другой фильм"
            document.getElementById('findAnotherBtn').addEventListener('click', findMatchingMovie);
        }
        
        // Функция отображения объяснения рекомендации
        function displayRecommendationExplanation(movie, commonGenreIds) {
            const explanationContainer = document.getElementById('recommendation-explanation');
            
            // Получаем названия общих жанров
            let commonGenres = [];
            if (commonGenreIds.length > 0) {
                commonGenres = movie.genres.filter(genre => commonGenreIds.includes(genre.id)).map(genre => genre.name);
            }
            
            // Формируем объяснение
            let explanation = `<h3>Почему мы рекомендуем этот фильм</h3><ul>`;
            
            if (commonGenres.length > 0) {
                explanation += `<li>Фильм соответствует общим интересам: ${commonGenres.join(', ')}</li>`;
            } else {
                // Если нет общих жанров, проверяем пересечение жанров
                const yourGenres = yourSelectedMovie.genres.map(g => g.name);
                const partnerGenres = partnerSelectedMovie.genres.map(g => g.name);
                const movieGenres = movie.genres.map(g => g.name);
                
                const yourMatches = movieGenres.filter(genre => yourGenres.includes(genre));
                const partnerMatches = movieGenres.filter(genre => partnerGenres.includes(genre));
                
                if (yourMatches.length > 0) {
                    explanation += `<li>Совпадает с вашими предпочтениями: ${yourMatches.join(', ')}</li>`;
                }
                
                if (partnerMatches.length > 0) {
                    explanation += `<li>Совпадает с предпочтениями вашей девушки: ${partnerMatches.join(', ')}</li>`;
                }
            }
            
            // Добавляем информацию о рейтинге
            explanation += `<li>Высокая оценка зрителей: ${movie.vote_average}/10</li>`;
            
            // Добавляем информацию о популярности
            if (movie.popularity > 50) {
                explanation += `<li>Популярный фильм: отличный выбор для совместного просмотра</li>`;
            }
            
            // Добавляем информацию о режиссере или актерах
            if (movie.credits && movie.credits.cast && movie.credits.cast.length > 0) {
                const topActor = movie.credits.cast[0];
                explanation += `<li>В главной роли: ${topActor.name}</li>`;
            }
            
            if (movie.credits && movie.credits.crew) {
                const director = movie.credits.crew.find(person => person.job === 'Director');
                if (director) {
                    explanation += `<li>Режиссер: ${director.name}</li>`;
                }
            }
            
            explanation += `</ul>`;
            
            explanationContainer.innerHTML = explanation;
            explanationContainer.style.display = 'block';
        }
        
        // Функция для отображения уведомления об ошибке
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = '#e74c3c';
            notification.style.color = 'white';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
            notification.style.zIndex = '1000';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Удаляем уведомление через 5 секунд
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
        }
    </script>
</body>
</html>
